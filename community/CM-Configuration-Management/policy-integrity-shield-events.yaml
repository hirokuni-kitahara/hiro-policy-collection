# This policy checks if Integrity Shield has denied one or
# more requests on the managed clusters.
#
# "inform" This policy will show "Not compliant" on UI when something was denied.

apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: update-test-policy-integrity-shield-events
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-5 Access Restrictions for Change
    integrityshield.io/message: IyBUaGlzIHBvbGljeSBjaGVja3MgaWYgSW50ZWdyaXR5IFNoaWVsZCBoYXMgZGVuaWVkIG9uZSBvcgojIG1vcmUgcmVxdWVzdHMgb24gdGhlIG1hbmFnZWQgY2x1c3RlcnMuCiMKIyAiaW5mb3JtIiBUaGlzIHBvbGljeSB3aWxsIHNob3cgIk5vdCBjb21wbGlhbnQiIG9uIFVJIHdoZW4gc29tZXRoaW5nIHdhcyBkZW5pZWQuCgphcGlWZXJzaW9uOiBwb2xpY3kub3Blbi1jbHVzdGVyLW1hbmFnZW1lbnQuaW8vdjEKa2luZDogUG9saWN5Cm1ldGFkYXRhOgogIG5hbWU6IHVwZGF0ZS10ZXN0LXBvbGljeS1pbnRlZ3JpdHktc2hpZWxkLWV2ZW50cwogIGFubm90YXRpb25zOgogICAgcG9saWN5Lm9wZW4tY2x1c3Rlci1tYW5hZ2VtZW50LmlvL3N0YW5kYXJkczogTklTVCBTUCA4MDAtNTMKICAgIHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby9jYXRlZ29yaWVzOiBDTSBDb25maWd1cmF0aW9uIE1hbmFnZW1lbnQKICAgIHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby9jb250cm9sczogQ00tNSBBY2Nlc3MgUmVzdHJpY3Rpb25zIGZvciBDaGFuZ2UKc3BlYzoKICByZW1lZGlhdGlvbkFjdGlvbjogaW5mb3JtCiAgZGlzYWJsZWQ6IGZhbHNlCiAgcG9saWN5LXRlbXBsYXRlczoKICAtIG9iamVjdERlZmluaXRpb246CiAgICAgIGFwaVZlcnNpb246IHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby92MQogICAgICBraW5kOiBDb25maWd1cmF0aW9uUG9saWN5CiAgICAgIG1ldGFkYXRhOgogICAgICAgIG5hbWU6IHVwZGF0ZS10ZXN0LXBvbGljeS1pbnRlZ3JpdHktc2hpZWxkLWFkbWlzc2lvbgogICAgICBzcGVjOgogICAgICAgIHJlbWVkaWF0aW9uQWN0aW9uOiBpbmZvcm0gIyB3aWxsIGJlIG92ZXJyaWRkZW4gYnkgcmVtZWRpYXRpb25BY3Rpb24gaW4gcGFyZW50IHBvbGljeQogICAgICAgIHNldmVyaXR5OiBsb3cKICAgICAgICBuYW1lc3BhY2VTZWxlY3RvcjoKICAgICAgICAgIGluY2x1ZGU6IFsiKiJdCiAgICAgICAgICBleGNsdWRlOiBbImt1YmUtKiIsICJvcGVuc2hpZnQtKiJdCiAgICAgICAgb2JqZWN0LXRlbXBsYXRlczoKICAgICAgICAtIGNvbXBsaWFuY2VUeXBlOiBtdXN0bm90aGF2ZQogICAgICAgICAgb2JqZWN0RGVmaW5pdGlvbjoKICAgICAgICAgICAgYXBpVmVyc2lvbjogdjEKICAgICAgICAgICAga2luZDogRXZlbnQKICAgICAgICAgICAgbWV0YWRhdGE6CiAgICAgICAgICAgICAgYW5ub3RhdGlvbnM6CiAgICAgICAgICAgICAgICBpbnRlZ3JpdHlzaGllbGQuaW8vZXZlbnRUeXBlOiB2ZXJpZnktcmVzdWx0CiAgICAgICAgICAgICAgICBpbnRlZ3JpdHlzaGllbGQuaW8vZXZlbnRSZXN1bHQ6IGRlbnkKLS0tCmFwaVZlcnNpb246IHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby92MQpraW5kOiBQbGFjZW1lbnRCaW5kaW5nCm1ldGFkYXRhOgogIG5hbWU6IHVwZGF0ZS10ZXN0LWJpbmRpbmctcG9saWN5LWludGVncml0eS1zaGllbGQtZXZlbnRzCnBsYWNlbWVudFJlZjoKICBuYW1lOiB1cGRhdGUtdGVzdC1wbGFjZW1lbnQtcG9saWN5LWludGVncml0eS1zaGllbGQtZXZlbnRzCiAga2luZDogUGxhY2VtZW50UnVsZQogIGFwaUdyb3VwOiBhcHBzLm9wZW4tY2x1c3Rlci1tYW5hZ2VtZW50LmlvCnN1YmplY3RzOgotIG5hbWU6IHVwZGF0ZS10ZXN0LXBvbGljeS1pbnRlZ3JpdHktc2hpZWxkLWV2ZW50cwogIGtpbmQ6IFBvbGljeQogIGFwaUdyb3VwOiBwb2xpY3kub3Blbi1jbHVzdGVyLW1hbmFnZW1lbnQuaW8KLS0tCmFwaVZlcnNpb246IGFwcHMub3Blbi1jbHVzdGVyLW1hbmFnZW1lbnQuaW8vdjEKa2luZDogUGxhY2VtZW50UnVsZQptZXRhZGF0YToKICBuYW1lOiB1cGRhdGUtdGVzdC1wbGFjZW1lbnQtcG9saWN5LWludGVncml0eS1zaGllbGQtZXZlbnRzCnNwZWM6CiAgY2x1c3RlckNvbmRpdGlvbnM6CiAgLSBzdGF0dXM6ICJUcnVlIgogICAgdHlwZTogTWFuYWdlZENsdXN0ZXJDb25kaXRpb25BdmFpbGFibGUKICBjbHVzdGVyU2VsZWN0b3I6CiAgICBtYXRjaEV4cHJlc3Npb25zOgogICAgLSB7a2V5OiBlbnZpcm9ubWVudCwgb3BlcmF0b3I6IEluLCB2YWx1ZXM6IFsiZGV2Il19Cg==
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRRlBCQUFCQ0FBNUZpRUUrU2psQVN5SlZoa3FGVDNLT1Q2Y3pnLzRpcmtGQW1BWkRjNGJIR2hwY205cmRXNXAKTG10cGRHRm9ZWEpoTVVCcFltMHVZMjl0QUFvSkVEaytuTTRQK0lxNVJiWUgvUnVsUllMRDIvMW9Gbkt6dVJodQpReDhmeWJ1KzZnd3owMytYSUtIMWh0UFBja3J1WUFyWHZEZzFYRGVxdWdQL0ZYNXdhYTBsSEVHSytORmdmajQ4CkI2ZDAydWltL1JzVnF0V3RicDJvZHBNYlBDQm5KS25aa3F2ZDE3S1JTbEg4OWpzV0tTelM2S3ZtakQ0cisyR3AKZ3FvOTYyT09HVUZSMGsxYXB4Vk5UQmJGRXlmL0dpU0h2MDN5VzZaSkt3OVhmbm9BamFvaFUvU2VzaXlwM0NFVApjWFB4dmR4VGxVOGVFUHB5TzBZZlA2bUx5dmZwc2RpRHBkcDd6Ti81NnVrNzIxelFGOG5Ha3Zka3g0d3djOTJICkxaMWZWWGY3eXlOVlBZWGtqd3orRFF4RktvTVorbmR2c1lpZS95dE9sRUF5YVBUSVpOZUNCbTk0ZE84cm15cEUKL2RjPQo9TTFOeAotLS0tLUVORCBQR1AgU0lHTkFUVVJFLS0tLS0K
spec:
  remediationAction: inform
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: update-test-policy-integrity-shield-admission
      spec:
        remediationAction: inform # will be overridden by remediationAction in parent policy
        severity: low
        namespaceSelector:
          include: ["*"]
          exclude: ["kube-*", "openshift-*"]
        object-templates:
        - complianceType: mustnothave
          objectDefinition:
            apiVersion: v1
            kind: Event
            metadata:
              annotations:
                integrityshield.io/eventType: verify-result
                integrityshield.io/eventResult: deny
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: update-test-binding-policy-integrity-shield-events
placementRef:
  name: update-test-placement-policy-integrity-shield-events
  kind: PlacementRule
  apiGroup: apps.open-cluster-management.io
subjects:
- name: update-test-policy-integrity-shield-events
  kind: Policy
  apiGroup: policy.open-cluster-management.io
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: update-test-placement-policy-integrity-shield-events
spec:
  clusterConditions:
  - status: "True"
    type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
    - {key: environment, operator: In, values: ["dev"]}
