# This policy checks if Integrity Shield has denied one or
# more requests on the managed clusters.
#
# "inform" This policy will show "Not compliant" on UI when something was denied.

apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: update-test-policy-integrity-shield-events
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-5 Access Restrictions for Change
    integrityshield.io/message: IyBUaGlzIHBvbGljeSBjaGVja3MgaWYgSW50ZWdyaXR5IFNoaWVsZCBoYXMgZGVuaWVkIG9uZSBvcgojIG1vcmUgcmVxdWVzdHMgb24gdGhlIG1hbmFnZWQgY2x1c3RlcnMuCiMKIyAiaW5mb3JtIiBUaGlzIHBvbGljeSB3aWxsIHNob3cgIk5vdCBjb21wbGlhbnQiIG9uIFVJIHdoZW4gc29tZXRoaW5nIHdhcyBkZW5pZWQuCgphcGlWZXJzaW9uOiBwb2xpY3kub3Blbi1jbHVzdGVyLW1hbmFnZW1lbnQuaW8vdjEKa2luZDogUG9saWN5Cm1ldGFkYXRhOgogIG5hbWU6IHVwZGF0ZS10ZXN0LXBvbGljeS1pbnRlZ3JpdHktc2hpZWxkLWV2ZW50cwogIGFubm90YXRpb25zOgogICAgcG9saWN5Lm9wZW4tY2x1c3Rlci1tYW5hZ2VtZW50LmlvL3N0YW5kYXJkczogTklTVCBTUCA4MDAtNTMKICAgIHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby9jYXRlZ29yaWVzOiBDTSBDb25maWd1cmF0aW9uIE1hbmFnZW1lbnQKICAgIHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby9jb250cm9sczogQ00tNSBBY2Nlc3MgUmVzdHJpY3Rpb25zIGZvciBDaGFuZ2UKc3BlYzoKICByZW1lZGlhdGlvbkFjdGlvbjogaW5mb3JtCiAgZGlzYWJsZWQ6IGZhbHNlCiAgcG9saWN5LXRlbXBsYXRlczoKICAtIG9iamVjdERlZmluaXRpb246CiAgICAgIGFwaVZlcnNpb246IHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby92MQogICAgICBraW5kOiBDb25maWd1cmF0aW9uUG9saWN5CiAgICAgIG1ldGFkYXRhOgogICAgICAgIG5hbWU6IHVwZGF0ZS10ZXN0LXBvbGljeS1pbnRlZ3JpdHktc2hpZWxkLWFkbWlzc2lvbgogICAgICBzcGVjOgogICAgICAgIHJlbWVkaWF0aW9uQWN0aW9uOiBpbmZvcm0gIyB3aWxsIGJlIG92ZXJyaWRkZW4gYnkgcmVtZWRpYXRpb25BY3Rpb24gaW4gcGFyZW50IHBvbGljeQogICAgICAgIHNldmVyaXR5OiBsb3cKICAgICAgICBuYW1lc3BhY2VTZWxlY3RvcjoKICAgICAgICAgIGluY2x1ZGU6IFsiKiJdCiAgICAgICAgICBleGNsdWRlOiBbImt1YmUtKiIsICJvcGVuc2hpZnQtKiJdCiAgICAgICAgb2JqZWN0LXRlbXBsYXRlczoKICAgICAgICAtIGNvbXBsaWFuY2VUeXBlOiBtdXN0bm90aGF2ZQogICAgICAgICAgb2JqZWN0RGVmaW5pdGlvbjoKICAgICAgICAgICAgYXBpVmVyc2lvbjogdjEKICAgICAgICAgICAga2luZDogRXZlbnQKICAgICAgICAgICAgbWV0YWRhdGE6CiAgICAgICAgICAgICAgYW5ub3RhdGlvbnM6CiAgICAgICAgICAgICAgICBpbnRlZ3JpdHlzaGllbGQuaW8vZXZlbnRUeXBlOiB2ZXJpZnktcmVzdWx0CiAgICAgICAgICAgICAgICBpbnRlZ3JpdHlzaGllbGQuaW8vZXZlbnRSZXN1bHQ6IGRlbnkKICAgICAgICAgICAgICAgICMgLSBvYmplY3REZWZpbml0aW9uOgogICAgICAgICAgICAgICAgIyAgICAgIyBUaGlzIGNvbmZpZ3VyYXRpb24gcG9saWN5IGNoZWNrcyBpZiB0aGUgb3BlcmF0b3IgcmVjb25jaWxlZCBhbGwgcmVzb3VyY2VzIGNvcnJlY3RseSBvciBub3QKICAgICAgICAgICAgICAgICMgICAgICMgT25jZSBhbGwgb2YgdGhlbSBhcmUgZmluaXNoZWQsIHdlYmhvb2sgc2hvdWxkIGJlIHRoZXJlLCBhbmQgdGhpcyBwb2xpY3kgcmVwb3J0cyBgQ29tcGxpYW50YAogICAgICAgICAgICAgICAgIyAgICAgYXBpVmVyc2lvbjogcG9saWN5Lm9wZW4tY2x1c3Rlci1tYW5hZ2VtZW50LmlvL3YxCiAgICAgICAgICAgICAgICAjICAgICBraW5kOiBDb25maWd1cmF0aW9uUG9saWN5CiAgICAgICAgICAgICAgICAjICAgICBtZXRhZGF0YToKICAgICAgICAgICAgICAgICMgICAgICAgbmFtZTogdXBkYXRlLXRlc3QtcG9saWN5LWludGVncml0eS1zaGllbGQtd2ViaG9vawogICAgICAgICAgICAgICAgIyAgICAgc3BlYzoKICAgICAgICAgICAgICAgICMgICAgICAgcmVtZWRpYXRpb25BY3Rpb246IGluZm9ybSAjIHRoaXMgbXVzdCBiZSBhbHdheXMgYGluZm9ybWAuCiAgICAgICAgICAgICAgICAjICAgICAgIHNldmVyaXR5OiBsb3cKICAgICAgICAgICAgICAgICMgICAgICAgb2JqZWN0LXRlbXBsYXRlczoKICAgICAgICAgICAgICAgICMgICAgICAgLSBjb21wbGlhbmNlVHlwZTogbXVzdGhhdmUKICAgICAgICAgICAgICAgICMgICAgICAgICBvYmplY3REZWZpbml0aW9uOgogICAgICAgICAgICAgICAgIyAgICAgICAgICAgYXBpVmVyc2lvbjogYWRtaXNzaW9ucmVnaXN0cmF0aW9uLms4cy5pby92MQogICAgICAgICAgICAgICAgIyAgICAgICAgICAga2luZDogTXV0YXRpbmdXZWJob29rQ29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgIyAgICAgICAgICAgbWV0YWRhdGE6CiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIG5hbWU6IGlzaGllbGQtd2ViaG9vay1jb25maWcKLS0tCmFwaVZlcnNpb246IHBvbGljeS5vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC5pby92MQpraW5kOiBQbGFjZW1lbnRCaW5kaW5nCm1ldGFkYXRhOgogIG5hbWU6IHVwZGF0ZS10ZXN0LWJpbmRpbmctcG9saWN5LWludGVncml0eS1zaGllbGQtZXZlbnRzCnBsYWNlbWVudFJlZjoKICBuYW1lOiB1cGRhdGUtdGVzdC1wbGFjZW1lbnQtcG9saWN5LWludGVncml0eS1zaGllbGQtZXZlbnRzCiAga2luZDogUGxhY2VtZW50UnVsZQogIGFwaUdyb3VwOiBhcHBzLm9wZW4tY2x1c3Rlci1tYW5hZ2VtZW50LmlvCnN1YmplY3RzOgotIG5hbWU6IHVwZGF0ZS10ZXN0LXBvbGljeS1pbnRlZ3JpdHktc2hpZWxkLWV2ZW50cwogIGtpbmQ6IFBvbGljeQogIGFwaUdyb3VwOiBwb2xpY3kub3Blbi1jbHVzdGVyLW1hbmFnZW1lbnQuaW8KLS0tCmFwaVZlcnNpb246IGFwcHMub3Blbi1jbHVzdGVyLW1hbmFnZW1lbnQuaW8vdjEKa2luZDogUGxhY2VtZW50UnVsZQptZXRhZGF0YToKICBuYW1lOiB1cGRhdGUtdGVzdC1wbGFjZW1lbnQtcG9saWN5LWludGVncml0eS1zaGllbGQtZXZlbnRzCnNwZWM6CiAgY2x1c3RlckNvbmRpdGlvbnM6CiAgLSBzdGF0dXM6ICJUcnVlIgogICAgdHlwZTogTWFuYWdlZENsdXN0ZXJDb25kaXRpb25BdmFpbGFibGUKICBjbHVzdGVyU2VsZWN0b3I6CiAgICBtYXRjaEV4cHJlc3Npb25zOgogICAgLSB7a2V5OiBlbnZpcm9ubWVudCwgb3BlcmF0b3I6IEluLCB2YWx1ZXM6IFsiZGV2MiJdfQo=
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRRlBCQUFCQ0FBNUZpRUUrU2psQVN5SlZoa3FGVDNLT1Q2Y3pnLzRpcmtGQW1BWXJOTWJIR2hwY205cmRXNXAKTG10cGRHRm9ZWEpoTVVCcFltMHVZMjl0QUFvSkVEaytuTTRQK0lxNVBaMEgvMWtHMTlCRTRkaHdYdHBQcmJOcAplSXdIcXFNR0lGYzVoay9Mc1p6MVNhTTZiaHREYjJ5b0VZUllYbmJFa1BTbXlpMFFocHZuMk9mcWtMNkVvZU5DCk13UDRGL1hyOEFuN0MvR2dxMkpxSUFDN0FZWDY1RmJnb0R2bDlFNmQ3cmFIUml4L01rS2hBOGMzdHpFOTgyancKN1YzWFBKNDFFNDdjN1hyTUR3dmsvYjlXTVNPaFNRdUZOZTlPZjBHNExPb211M2NwRTRPQ3hIZ2Q1cUI1c0hSKwpQbXc0NG1sdVQ1NUhKTmZyOFFoQTdwbVpYVGN1OFY4anNxMDg4bGliZkJkcVJ0MG53amJRWWVCV2NqSW9KL2ZECnNpU25rcnJuNHVZRWdtSTFTMk4yWGVaSHJzL3FmdW9tUWtHWnZmbVEvaFEvR203UUdxdmlmcG5QbWxjL2RjQU4KTVFNPQo9d3Z5MgotLS0tLUVORCBQR1AgU0lHTkFUVVJFLS0tLS0K
spec:
  remediationAction: inform
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: update-test-policy-integrity-shield-admission
      spec:
        remediationAction: inform # will be overridden by remediationAction in parent policy
        severity: low
        namespaceSelector:
          include: ["*"]
          exclude: ["kube-*", "openshift-*"]
        object-templates:
        - complianceType: mustnothave
          objectDefinition:
            apiVersion: v1
            kind: Event
            metadata:
              annotations:
                integrityshield.io/eventType: verify-result
                integrityshield.io/eventResult: deny
                # - objectDefinition:
                #     # This configuration policy checks if the operator reconciled all resources correctly or not
                #     # Once all of them are finished, webhook should be there, and this policy reports `Compliant`
                #     apiVersion: policy.open-cluster-management.io/v1
                #     kind: ConfigurationPolicy
                #     metadata:
                #       name: update-test-policy-integrity-shield-webhook
                #     spec:
                #       remediationAction: inform # this must be always `inform`.
                #       severity: low
                #       object-templates:
                #       - complianceType: musthave
                #         objectDefinition:
                #           apiVersion: admissionregistration.k8s.io/v1
                #           kind: MutatingWebhookConfiguration
                #           metadata:
                #             name: ishield-webhook-config
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: update-test-binding-policy-integrity-shield-events
placementRef:
  name: update-test-placement-policy-integrity-shield-events
  kind: PlacementRule
  apiGroup: apps.open-cluster-management.io
subjects:
- name: update-test-policy-integrity-shield-events
  kind: Policy
  apiGroup: policy.open-cluster-management.io
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: update-test-placement-policy-integrity-shield-events
spec:
  clusterConditions:
  - status: "True"
    type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
    - {key: environment, operator: In, values: ["dev2"]}
