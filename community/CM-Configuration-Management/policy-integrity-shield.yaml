# This policy verifies the installation of Integrity Shield on the managed clusters.
# 
# "enforce", it will install Integirty Shield operator

apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-integrity-shield
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-5 Access Restrictions for Change
    integrityshield.io/message: H4sIAHjDLGAAA+1ZX2/bNhB/96c4OG9DqKYoAmx687xh60OzoM76svaBps42F4kUSMqLV/S770hKjuxIlpMm2TKUKJKGPN6/393xKJ7A1UpaKHUuxQbWaORCogW3QpDKOp7n3EmtQC/grXK4NNJtYLaSmGdA056u4IovMQORV9ahscnoBOjfGNVCG4HjU5AO/pJ53nCMnKRpcSrRcKfNaMRL+YF4kMi0ViqhRcVq5iwKK1C5ROpX69eja6myFC4D6ahAxzPueDoCULzAhgeTje7MBom0zpXSLhhnPTkcIY60Vxk3mU3h4u3sCmaX8P3ZGTt/c+R+wUkLbcjBKUzfwVSrhVxWJnr43Zb0WG5aOaPzwIudw0QItBbeo3VGimAXEAAwXXG1xJEtUXg7De3PZBA5CVQp1EDRYiYtn+dIDl3w3PqZ2n8Oi5IiAWtXMdDzP1G4n3AhlQxcwrwf90aw2RiR3HFKDWtD0Ya3GQdhZn7VljwYF0fjh2b0+wNOQnjveSAwSO7sAkoiTeljZJahgvkm7jUoiE4toeSGVCH7Yc3zCgMy3ZySlnIWfUa6TQq/yuWqtRDdvw9LMxgITQuSK4FXm5L8U5DvKdxXfI07lHAAyF1cLu54sgvwFpyHQNsF7w5qTTlgdkMhU7yskNPLlx5rq38v1tpINlFgE6ENav+reNURYBHE32rqX4yuyq8Kwm30LTtZxQ0hFY4M3fbYD4lmOG6W6LZJZrtovLP/X7liq/m3ZHnKZOF5ueJ9KTOr5lYYWXruj1m2nyllBDU2CvMUgpEdBHW7eZlzNSlLowngFCaV0wWhKh7FLqsr440ibxeValcP20t9cesLn3kkZOEo7cw1OoqZjgOWNlJ5cBSt09mHA/ol67PkdfLmZZUAYb5VgEepAPR/m2zdG70b8TtYBLa3ullzMdodD6gDFg355pmqAF8E9xAOn790ZU7gHkO2+0wNd95NxKJclhRaN+dnP3SSyuijSVZI9TtZeRHsH0eNU2+2FMiF0JVyaU9KMfrtf2YZgXYdl3OsJ1iMaOFMPu7WQM0EMd6WkBnmFCLadJvm6UmDDPuWfTyOv+sWBYA3w5uvqzmyXg6B5LbIddJZuVRoDiEUnCL7eiIvQw30TVtdDmga9RhiMOOUvTgLtH28GFgPEkXGNOL79EIH+LA6VY9SnyoDbmo8wIYNLPJntCDCQr9BVShaAxZhwSWdxd1w3Erv6YGjLffTzKIwsb9OvQBDhZ/FuY4NBuNJ7f1EhJdGL2Te35PvHHDGdl0Z/KAOxJFr3le9rCI76k7E6pD/PBFV+3DTOeIE7ysNS0Wd4uNoU1HtUw8uhumBrHwM/nWx7ZUSWorpCsX1fwWbZux83OwhIa66kH/jJXfEXr0w9f3wyF4aanNufElI+mCqVJ1BE+cOlcxnNZMf1iWKGjdNVNL66Jx8HPOytIda75W2vutnGZa53vgvsx/HQ6nytbJs61L4dNLsRgkWi+zTCaEOXytBlZuay/uak/M55l7IEd/h61kfxs8gIvQ5TyTHaO3qHrRfwt6nqqEWFCAoMEwGMW9/vqGrmbW37zL9NtJBfswNVtq6D+v/hr07mruIvx0NkIYro03hj7EzFY4/jRhjD37E8rd/P/sj/Um52PGcNY8rrO9Zq2xYvMdF6xGsme3dt63V2/10Eo6gVSQHkm3UbvzY4ONbx9lwn3q87+ShSnDXxcG+jufCQU8199BaEHWqmWw9IjL/rcZVFBHjKx8Qdfi4cL2MT3zZdG/rZE3dsK/ut2x3s6UvLxh8DimAai2NVl7v053gPW3FZ4br8acvo38ANvWI6vEdAAA=
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRSFBCQUFCQ0FBNUZpRUVWSlRXK3hrWFZWcUdrSlRYZXJVUms4em81N0VGQW1Bc3czZ2JIR2hwY205cmRXNXAKTG10cGRHRm9ZWEpoTVVCcFltMHVZMjl0QUFvSkVIcTFFWlBNNk9leHFnb0wvMTBUeldVU2MyRnRNeTZVd2QzTApKcC9IY1BqVG1QSFFIcHpSY0JaVWdhc0FJbUw2ekNKbStXZEk4N1ZVMXN1VkN2TVV2SkZ3dmlOZWRyVVJKeCtICkQzU0dqemZMNlFIdGtWTHBENGFUSkFBd05Hd0pLNC8yWEV4cnJ5YU8vTkJybENuVTBLUTAyc3N3RUp4cmxMZDgKVVptVUpROEF4WTRmbjI3WVdPay9CcmVKOUtEd0VhYkRRMUVUL3U2eTFYMHlmUjdUeXhHQVU5eG42ak8zNzg5NApydHBGM3U1WGsvUHY2UlNIMzFEY2thbExmcUwveHg1L0xIaVRwM2tXV1VhZDFYR3dVdUFSODFaNHFweWJxclVQCkJ0L2dzVnlLNFAvczI0SXg0VUNIZmZlOHpWNEdFUXhsMXRlS2JnZDZJejlBcCtiN2FsTitUSDhRYkx0K0htanYKNTdEcGJiTXgweVR4KzNlb3FmMmdVcWljdENUTmI2cW5udDhUVTRSRWovZWFCalVuMjF1aFB4SWkrU250N1J6SQpDTEM5YWlabDg0T1pwRmtjM0ZmRlRDQkV1eFF1OG4zTWU2eWtVV1VGdXdQUEtSQVM3QStYWUxtcnZSYzdmN2JoClR4Q0taZ1ZNU3lMeXYrMEtTZlhIQzJXVW1PcnVWci8wK3ZhNDc4WVpvd1lPSmc9PQo9MWJ3SwotLS0tLUVORCBQR1AgU0lHTkFUVVJFLS0tLS0K
spec:
  remediationAction: enforce
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-namespace
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: High
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                kind: Namespace
                apiVersion: v1
                metadata:
                  name: integrity-shield-operator-system
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-og
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: high
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: operators.coreos.com/v1
                kind: OperatorGroup
                metadata:
                  name: integrity-operator-group
                  namespace: integrity-shield-operator-system
                spec:
                  targetNamespaces:
                    - integrity-shield-operator-system
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-sub
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: high
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: Subscription
                metadata:
                  name: integrity-shield-operator
                  namespace: integrity-shield-operator-system
                spec:
                  channel: alpha
                  installPlanApproval: Automatic
                  name: integrity-shield-operator
                  source: community-operators
                  sourceNamespace: openshift-marketplace
                  startingCSV: integrity-shield-operator.v0.1.3
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-cr
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: high
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: apis.integrityshield.io/v1alpha1
                kind: IntegrityShield
                metadata:
                  name: integrity-shield-server
                  namespace: integrity-shield-operator-system
                spec:
                  affinity: {}
                  shieldConfig:
                    verifyType: pgp # x509
                    iShieldAdminUserName: "system:serviceaccount:open-cluster-management-agent-addon:klusterlet-addon-policyctrl"
                    inScopeNamespaceSelector:
                      include:
                        - "*"
                      exclude:
                        - "kube-*"
                        - "openshift-*"
                  signerConfig:
                    policies:
                      - namespaces:
                          - "*"
                        signers:
                          - "SampleSigner"
                      - scope: "Cluster"
                        signers:
                          - "SampleSigner"
                    signers:
                      - name: "SampleSigner"
                        keyConfig: sample-signer-keyconfig
                        subjects:
                          - email: "*"
                  keyConfig:
                    - name: sample-signer-keyconfig
                      secretName: keyring-secret
                  resourceSigningProfiles:
                    - name: policy-rsp
                      protectRules:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                      ignoreRules:
                        - match:
                            - username: "system:serviceaccount:open-cluster-management-agent:*"
                            - username: "system:serviceaccount:open-cluster-management-agent-addon:*"
                      forceCheckRules:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                              kind: Policy
                      kustomizePatterns:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                              kind: Policy
                          namePrefix: "*."
                      unprotectAttrs:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                          attrs:
                            - "metadata.annotations.\"apps.open-cluster-management.io/hosting-deployable\""
                            - "metadata.annotations.\"apps.open-cluster-management.io/hosting-subscription\""
                            - "metadata.annotations.\"apps.open-cluster-management.io/sync-source\""
                            - "metadata.annotations.\"apps.open-cluster-management.io/reconcile-option\""
                            - "metadata.labels.\"policy.open-cluster-management.io/cluster-name\""
                            - "metadata.labels.\"policy.open-cluster-management.io/cluster-namespace\""
                            - "metadata.labels.\"policy.open-cluster-management.io/root-policy\""
                      targetNamespaceSelector:
                        labelSelector:
                          matchExpressions:
                            - key: policy.open-cluster-management.io/isClusterNamespace
                              operator: In
                              values: ["true"]
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: binding-policy-integrity-shield
placementRef:
  name: placement-policy-integrity-shield
  kind: PlacementRule
  apiGroup: apps.open-cluster-management.io
subjects:
  - name: policy-integrity-shield
    kind: Policy
    apiGroup: policy.open-cluster-management.io
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: placement-policy-integrity-shield
spec:
  clusterConditions:
    - status: "True"
      type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
      - {key: environment, operator: In, values: ["dev"]}
